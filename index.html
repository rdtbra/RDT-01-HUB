<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>RDT HUB ‚Äî v5 Infinite Search</title>
  <style>
    :root{
      --bg: #0f172a; --text: #e6e8ef; --radius: 12px; --accent: #6366f1;
      --card-bg: #1e293b; --border: rgba(255,255,255,0.15);
      --danger: #ef4444;
    }
    html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:'Segoe UI',sans-serif;overflow:hidden;}
    * { box-sizing: border-box; outline: none; user-select: none; }

    /* --- UI GERAL --- */
    .toolbar{
      position:fixed;left:50%;transform:translateX(-50%);top:20px;z-index:2000;
      display:flex;gap:8px;align-items:center;
      background:rgba(15, 23, 42, 0.95); border:1px solid var(--border);
      padding: 8px 16px; border-radius:12px; box-shadow: 0 10px 30px rgba(0,0,0,0.5);
    }
    .btn{
      border:1px solid rgba(255,255,255,0.1); background:rgba(255,255,255,0.05); color:var(--text);
      padding:6px 12px; border-radius:6px; cursor:pointer; font-size:13px; display:flex; align-items:center; gap:6px; transition:0.2s; white-space: nowrap;
    }
    .btn:hover{background:rgba(255,255,255,0.15);}
    .btn-primary { background: var(--accent); border-color: transparent; color: white; }
    .btn-danger { color: #fca5a5; border-color: rgba(239,68,68,0.3); }
    .btn-danger:hover { background: rgba(239,68,68,0.2); }
    .sep { width:1px; height:20px; background:rgba(255,255,255,0.15); margin:0 4px; }

    /* Search Bar */
    .search-box { position: relative; display: flex; align-items: center; }
    .search-input {
      background: rgba(0,0,0,0.3); border: 1px solid var(--border); border-radius: 6px;
      padding: 6px 10px 6px 30px; color: #fff; width: 200px; transition: width 0.2s;
    }
    .search-input:focus { width: 280px; border-color: var(--accent); }
    .search-icon { position: absolute; left: 8px; font-size: 12px; opacity: 0.5; pointer-events: none; }

    /* --- CANVAS --- */
    .viewport{ width:100%; height:100%; position:relative; cursor:grab; overflow:hidden; }
    .viewport.dragging{cursor:grabbing}
    /* Grid Infinito via CSS Background */
    .viewport {
      background-color: var(--bg);
      background-image: radial-gradient(rgba(255,255,255,0.08) 1px, transparent 1px);
      background-size: 40px 40px;
      /* A posi√ß√£o do background ser√° controlada via JS para o efeito infinito */
    }
    .world{ position:absolute;left:0;top:0; transform-origin:0 0; will-change: transform; }

    /* --- ENVELOPE --- */
    .envelope{
      position:absolute; width:280px; border-radius: var(--radius);
      background: var(--card-bg); border: 1px solid var(--border);
      box-shadow: 0 4px 15px rgba(0,0,0,0.3); display: flex; flex-direction: column;
      transition: box-shadow 0.2s, border-color 0.2s, transform 0.3s;
    }
    .envelope.open {
      width: 950px; height: 600px; z-index: 100 !important;
      box-shadow: 0 50px 100px rgba(0,0,0,0.8); border-color: rgba(255,255,255,0.4);
    }
    /* Anima√ß√£o de Destaque (Busca) */
    @keyframes highlightPulse {
      0% { box-shadow: 0 0 0 0px rgba(99, 102, 241, 0.7); transform: scale(1); }
      50% { box-shadow: 0 0 0 20px rgba(99, 102, 241, 0); transform: scale(1.05); }
      100% { box-shadow: 0 0 0 0px rgba(99, 102, 241, 0); transform: scale(1); }
    }
    .envelope.highlight { animation: highlightPulse 1s ease-out; border-color: var(--accent); z-index: 200; }

    /* Header */
    .env-head{
      height: 45px; display:flex; justify-content:space-between; align-items:center;
      padding: 0 10px; background: rgba(0,0,0,0.3); border-bottom: 1px solid var(--border);
      cursor: grab; border-radius: var(--radius) var(--radius) 0 0;
    }
    .env-head:active { cursor: grabbing; }
    .env-name { font-weight: 700; padding: 2px 6px; border-radius: 4px; cursor: text; font-size: 14px; }
    .env-name:focus { background: rgba(0,0,0,0.8); cursor: text; }

    /* Body Fechado */
    .env-closed { padding: 15px; display: flex; flex-direction: column; align-items: center; gap: 10px; }
    .env-thumb { width: 100%; height: 120px; object-fit: cover; border-radius: 8px; background: #000; border: 1px solid var(--border); }
    .env-stats { font-size: 12px; color: #94a3b8; display: flex; gap: 10px; }

    /* Body Aberto */
    .env-open { display: flex; flex: 1; overflow: hidden; background: rgba(255,255,255,0.02); }
    .col-left { width: 300px; padding: 15px; border-right: 1px solid var(--border); background: rgba(0,0,0,0.2); display: flex; flex-direction: column; gap: 15px; overflow-y: auto; }
    .col-right { flex: 1; display: flex; flex-direction: column; background: #1e293b; overflow: hidden; }

    /* Componentes Esquerda */
    .cover-wrapper { position: relative; width: 100%; aspect-ratio: 16/9; background: #000; border-radius: 8px; border: 1px solid var(--border); overflow: hidden; }
    .cover-img { width: 100%; height: 100%; object-fit: cover; }
    
    .color-picker { display: flex; gap: 8px; justify-content: center; padding: 10px; background: rgba(0,0,0,0.2); border-radius: 8px; flex-wrap: wrap; }
    .color-dot { width: 24px; height: 24px; border-radius: 50%; cursor: pointer; border: 2px solid rgba(255,255,255,0.2); transition: transform 0.2s; }
    .color-dot:hover { transform: scale(1.1); }
    .color-dot.selected { border-color: #fff; box-shadow: 0 0 0 2px #fff; }

    .desc-area { flex: 1; background: rgba(0,0,0,0.3); border: 1px solid var(--border); color: #fff; padding: 10px; border-radius: 6px; resize: none; font-size: 13px; min-height: 100px; }

    /* Tabs */
    .tabs-head { display: flex; background: rgba(0,0,0,0.2); border-bottom: 1px solid var(--border); }
    .tab-btn { padding: 12px 24px; background: transparent; border: none; color: rgba(255,255,255,0.6); cursor: pointer; border-bottom: 3px solid transparent; font-weight: 600; }
    .tab-btn.active { color: #fff; border-bottom-color: var(--accent); background: rgba(255,255,255,0.05); }
    .tab-content { flex: 1; padding: 15px; overflow-y: auto; display: none; }
    .tab-content.active { display: block; }

    /* Lista IA */
    .team-item { display: flex; align-items: center; gap: 10px; padding: 8px; background: rgba(255,255,255,0.03); border-radius: 6px; margin-bottom: 6px; border: 1px solid transparent; }
    .team-item:hover { border-color: var(--border); background: rgba(255,255,255,0.05); }
    .team-code { font-family: monospace; font-size: 11px; background: rgba(99,102,241,0.2); color: #a5b4fc; padding: 2px 6px; border-radius: 4px; min-width: 35px; text-align: center; }
    
    /* Etiquetas */
    .tags-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(100%, 1fr)); gap: 10px; }
    .etiqueta { display: flex; gap: 10px; padding: 10px; background: rgba(0,0,0,0.3); border: 1px solid var(--border); border-radius: 8px; }
    .etiqueta-thumb { width: 60px; height: 60px; background: #000; border-radius: 6px; flex-shrink: 0; cursor: pointer; border: 1px solid var(--border); object-fit: cover; }
    .etiqueta-info { flex: 1; display: flex; flex-direction: column; gap: 5px; }
    .etiqueta-text { width: 100%; background: transparent; border: none; color: #fff; font-size: 13px; resize: none; height: 100%; }

    /* MODAL */
    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 3000; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
    .modal { background: #1e293b; width: 450px; padding: 25px; border-radius: 16px; border: 1px solid var(--border); box-shadow: 0 25px 50px rgba(0,0,0,0.9); }
    .form-row { display: flex; gap: 10px; margin-bottom: 15px; }
    .form-group { margin-bottom: 15px; flex: 1; }
    .form-group label { display: block; font-size: 12px; color: #94a3b8; margin-bottom: 6px; font-weight: 600; }
    .form-group input { width: 100%; padding: 10px; background: rgba(0,0,0,0.3); border: 1px solid var(--border); color: #fff; border-radius: 6px; }
    .form-group input:focus { border-color: var(--accent); }

    .hidden { display: none !important; }
  </style>
  
  <script src="data.js" onerror="console.log('Iniciando vazio.')"></script>
</head>
<body>

  <!-- Inputs -->
  <input type="file" id="fileInput" accept=".js" style="display:none">
  <input type="file" id="fileInputLegacy" accept=".js,.txt" style="display:none">

  <!-- Toolbar -->
  <div class="toolbar">
    <button class="btn" id="btnAddEnv"><span>‚ûï</span> Novo</button>
    <div class="sep"></div>
    
    <!-- Busca -->
    <div class="search-box">
      <span class="search-icon">üîç</span>
      <input type="text" id="searchInput" class="search-input" placeholder="Buscar envelope...">
    </div>

    <div class="sep"></div>
    <button class="btn" id="btnImportLegacy">üì¶ Migrar</button>
    <button class="btn" id="btnLoad">üìÇ Abrir</button>
    <button class="btn btn-primary" id="btnExport">üíæ Salvar</button>
  </div>

  <!-- Mesa -->
  <div class="viewport" id="viewport">
    <div class="world" id="world"></div>
  </div>

  <!-- Modal de Edi√ß√£o -->
  <div id="editModal" class="modal-overlay hidden">
    <div class="modal">
      <h3 id="modalTitle" style="margin-top:0; color:#fff; border-bottom:1px solid var(--border); padding-bottom:15px">Editar Item</h3>
      <div id="modalFields"></div>
      <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:20px; border-top:1px solid var(--border); padding-top:15px">
        <button class="btn" id="btnCancelModal">Cancelar</button>
        <button class="btn btn-primary" id="btnSaveModal">Salvar Altera√ß√µes</button>
      </div>
    </div>
  </div>

<script>
(() => {
  // --- Config ---
  const ENV_PALETTE = ["#1e293b", "#312e81", "#7f1d1d", "#78350f", "#064e3b", "#831843", "#000000"];
  let STATE = { cam: {x:0, y:0, z:1}, envelopes: [] };
  let editingCtx = null; 

  const viewport = document.getElementById("viewport");
  const world = document.getElementById("world");
  const modal = document.getElementById("editModal");
  const searchInput = document.getElementById("searchInput");

  // --- Init ---
  function init() {
    if (window.RDT_DATA) {
      STATE.envelopes = window.RDT_DATA.envelopes || [];
      if(window.RDT_DATA.cam) STATE.cam = window.RDT_DATA.cam;
    } else {
      STATE.envelopes = [{ 
        id: "env-demo", name: "Exemplo Inicial", color: ENV_PALETTE[1], x: 100, y: 100, isOpen: true, 
        team: [{code:"M01", label:"Link IA", url:"#", checked:true}],
        tags: [{id:1, text:"Anota√ß√µes...", url:"#", img:"https://placehold.co/60x60/333/FFF?text=IMG"}],
        icon: "", description: ""
      }];
    }
    applyCam();
    render();
  }

  // --- Render ---
  function render() {
    STATE.envelopes.forEach(env => {
      let el = document.getElementById(env.id);
      if (!el) {
        el = document.createElement("div"); el.id = env.id; el.className = "envelope"; world.appendChild(el);
        el.addEventListener("pointerdown", e => {
          if(e.target.closest('input, textarea, button, .etiqueta-thumb, .env-name, .color-dot, .team-item')) return;
          startDragEnv(e, env);
        });
      }

      el.style.left = env.x + "px"; el.style.top = env.y + "px";
      const baseColor = env.color || ENV_PALETTE[0];
      el.style.background = env.isOpen ? `linear-gradient(145deg, ${baseColor}, #0f172a)` : baseColor;

      if (env.isOpen) { el.classList.add("open"); el.style.zIndex = 100 + STATE.envelopes.indexOf(env); }
      else { el.classList.remove("open"); el.style.zIndex = ""; }

      const hash = `${env.isOpen}-${env.team.length}-${env.tags.length}-${env.name}-${env.color}-${env.icon}`;
      if (el.dataset.hash !== hash || env._forceUpdate) {
        el.dataset.hash = hash; env._forceUpdate = false;
        renderContent(el, env);
      }
    });
  }

  function renderContent(el, env) {
    const isOpen = env.isOpen;
    const headerHTML = `
      <div class="env-head">
        <div style="display:flex;align-items:center;gap:10px;flex:1;overflow:hidden">
          <span class="env-name" contenteditable="true" spellcheck="false">${env.name}</span>
        </div>
        <div style="display:flex; gap:6px;">
          ${!isOpen ? `<span style="font-size:12px;opacity:0.7">${env.tags.length} Tags ‚Ä¢ ${env.team.length} IA</span>` : ''}
          <button class="btn btn-danger btn-del-env" style="padding:4px 8px">üóëÔ∏è</button>
          ${isOpen ? `<button class="btn btn-close" style="padding:4px 8px">‚úñ</button>` : ''}
        </div>
      </div>`;

    if (!isOpen) {
      el.innerHTML = headerHTML + `
        <div class="env-closed">
          ${env.icon ? `<img src="${env.icon}" class="env-thumb">` : '<div class="env-thumb" style="display:flex;align-items:center;justify-content:center;color:#666">Sem Capa</div>'}
          <div class="env-stats"><span>${env.tags.length} Etiquetas</span> ‚Ä¢ <span>${env.team.length} Links</span></div>
          <button class="btn btn-primary btn-open" style="width:100%">Abrir Envelope</button>
        </div>`;
    } else {
      const teamHTML = env.team.map((m, i) => `
        <div class="team-item">
          <input type="checkbox" class="chk-team" data-idx="${i}" ${m.checked?'checked':''}>
          <span class="team-code">${m.code||'#'}</span>
          <a href="${m.url}" target="_blank" style="flex:1;color:#fff;text-decoration:none;font-size:13px">${m.label}</a>
          <button class="btn btn-edit-team" data-idx="${i}">‚úèÔ∏è</button>
          <button class="btn btn-danger btn-del-team" data-idx="${i}">üóëÔ∏è</button>
          <button class="btn" onclick="window.open('${m.url}','_blank')">‚Üó</button>
        </div>
      `).join('');

      const tagsHTML = env.tags.map(t => `
        <div class="etiqueta" data-id="${t.id}">
          <img src="${t.img}" class="etiqueta-thumb" title="Abrir Link" onclick="window.open('${t.url||'#'}', '_blank')" onerror="this.src='https://placehold.co/60x60/333/FFF?text=ERR'">
          <div class="etiqueta-info">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <span style="font-size:11px;color:#aaa">Link: ${t.url ? 'Sim' : 'N√£o'}</span>
              <div style="display:flex;gap:4px">
                <button class="btn btn-edit-tag" style="padding:2px 6px;font-size:11px">‚úèÔ∏è</button>
                <button class="btn btn-danger btn-del-tag" style="padding:2px 6px;font-size:11px">üóëÔ∏è</button>
              </div>
            </div>
            <textarea class="etiqueta-text" placeholder="Coment√°rios...">${t.text}</textarea>
          </div>
        </div>
      `).join('');

      el.innerHTML = headerHTML + `
        <div class="env-open">
          <div class="col-left">
            <div class="cover-wrapper">${env.icon ? `<img src="${env.icon}" class="cover-img">` : '<span style="position:absolute;inset:0;display:flex;align-items:center;justify-content:center;color:#666">Sem Capa</span>'}</div>
            <button class="btn btn-change-cover" style="width:100%;justify-content:center">üñºÔ∏è Alterar Capa</button>
            <div class="color-picker">${ENV_PALETTE.map(c => `<div class="color-dot ${env.color===c?'selected':''}" style="background:${c}" data-c="${c}"></div>`).join('')}</div>
            <textarea class="desc-area" placeholder="Descri√ß√£o geral...">${env.description||''}</textarea>
          </div>
          <div class="col-right">
            <div class="tabs-head">
              <button class="tab-btn active" data-tab="tags">Etiquetas (${env.tags.length})</button>
              <button class="tab-btn" data-tab="team">Equipe IA (${env.team.length})</button>
            </div>
            <div class="tab-content active" id="tab-tags">
              <div class="tags-grid">${tagsHTML}</div>
              <button class="btn btn-add-tag" style="width:100%;margin-top:10px">‚ûï Nova Etiqueta</button>
            </div>
            <div class="tab-content" id="tab-team">
              <button class="btn btn-primary btn-open-all" style="width:100%;margin-bottom:10px">üöÄ Abrir Selecionados</button>
              <div style="display:flex;flex-direction:column;gap:4px">${teamHTML}</div>
              <button class="btn btn-add-team" style="width:100%;margin-top:10px">‚ûï Novo Link</button>
            </div>
          </div>
        </div>`;
    }
    attachEvents(el, env);
  }

  function attachEvents(el, env) {
    const btnOpen = el.querySelector('.btn-open'); if(btnOpen) btnOpen.onclick = () => { env.isOpen = true; env._forceUpdate = true; render(); };
    const btnClose = el.querySelector('.btn-close'); if(btnClose) btnClose.onclick = () => { env.isOpen = false; env._forceUpdate = true; render(); };
    const btnDelEnv = el.querySelector('.btn-del-env'); if(btnDelEnv) btnDelEnv.onclick = () => { if(confirm("Apagar Envelope?")) { STATE.envelopes = STATE.envelopes.filter(e=>e.id!==env.id); el.remove(); } };
    
    const nameEl = el.querySelector('.env-name');
    if(nameEl) {
      nameEl.onblur = () => { env.name = nameEl.innerText; };
      nameEl.onkeydown = e => { if(e.key==='Enter'){e.preventDefault(); nameEl.blur();} };
      nameEl.onpointerdown = e => e.stopPropagation();
    }

    if(env.isOpen) {
      el.querySelectorAll('.color-dot').forEach(d => d.onclick = () => { env.color = d.dataset.c; env._forceUpdate = true; render(); });
      const desc = el.querySelector('.desc-area'); if(desc) desc.oninput = () => env.description = desc.value;
      el.querySelector('.btn-change-cover').onclick = () => { const url = prompt("URL da Capa:", env.icon); if(url!==null) { env.icon = url; env._forceUpdate = true; render(); } };

      el.querySelectorAll('.tab-btn').forEach(btn => btn.onclick = () => {
        el.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        el.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        btn.classList.add('active');
        el.querySelector(btn.dataset.tab === 'team' ? '#tab-team' : '#tab-tags').classList.add('active');
      });

      // Equipe
      el.querySelectorAll('.chk-team').forEach(chk => chk.onchange = () => env.team[chk.dataset.idx].checked = chk.checked);
      const btnAll = el.querySelector('.btn-open-all'); 
      if(btnAll) btnAll.onclick = () => { let d=0; env.team.filter(m=>m.checked).forEach(m => { setTimeout(() => window.open(m.url,'_blank'), d); d+=300; }); };
      const btnAddTeam = el.querySelector('.btn-add-team');
      if(btnAddTeam) btnAddTeam.onclick = () => { const n={code:"LNK", label:"Novo", url:"#", checked:true}; env.team.push(n); env._forceUpdate=true; render(); openEditor('team', n, env); };
      el.querySelectorAll('.btn-edit-team').forEach(btn => btn.onclick = () => openEditor('team', env.team[btn.dataset.idx], env));
      el.querySelectorAll('.btn-del-team').forEach(btn => btn.onclick = () => { if(confirm("Excluir?")) { env.team.splice(btn.dataset.idx, 1); env._forceUpdate=true; render(); } });

      // Etiquetas
      const btnAddTag = el.querySelector('.btn-add-tag');
      if(btnAddTag) btnAddTag.onclick = () => { const n={id:Date.now(), text:"", url:"", img:`https://placehold.co/60x60/333/FFF?text=IMG`}; env.tags.push(n); env._forceUpdate=true; render(); openEditor('tag', n, env); };
      el.querySelectorAll('.etiqueta-text').forEach(inp => inp.oninput = e => { const t = env.tags.find(tag=>tag.id==e.target.closest('.etiqueta').dataset.id); if(t) t.text = e.target.value; });
      el.querySelectorAll('.btn-edit-tag').forEach(btn => btn.onclick = e => { const id = e.target.closest('.etiqueta').dataset.id; openEditor('tag', env.tags.find(t=>t.id==id), env); });
      el.querySelectorAll('.btn-del-tag').forEach(btn => btn.onclick = e => { if(confirm("Excluir?")) { const id = e.target.closest('.etiqueta').dataset.id; env.tags = env.tags.filter(t=>t.id!=id); env._forceUpdate=true; render(); } });
    }
  }

  // --- EDITOR ---
  function openEditor(type, item, env) {
    editingCtx = { type, item, env };
    const fields = document.getElementById("modalFields");
    if (type === 'team') {
      document.getElementById("modalTitle").innerText = "Editar Link da Equipe";
      fields.innerHTML = `<div class="form-row"><div class="form-group" style="flex:0 0 80px"><label>C√≥digo</label><input id="inpCode" value="${item.code||''}"></div><div class="form-group"><label>R√≥tulo</label><input id="inpLabel" value="${item.label||''}"></div></div><div class="form-group"><label>URL</label><input id="inpUrl" value="${item.url||''}"></div>`;
    } else {
      document.getElementById("modalTitle").innerText = "Editar Etiqueta";
      fields.innerHTML = `<div class="form-group"><label>Texto</label><input id="inpText" value="${item.text||''}"></div><div class="form-group"><label>URL Destino</label><input id="inpUrl" value="${item.url||''}"></div><div class="form-group"><label>URL Imagem</label><input id="inpImg" value="${item.img||''}"></div>`;
    }
    modal.classList.remove("hidden");
  }
  document.getElementById("btnCancelModal").onclick = () => modal.classList.add("hidden");
  document.getElementById("btnSaveModal").onclick = () => {
    if (editingCtx) {
      const { type, item, env } = editingCtx;
      if (type === 'team') { item.code = document.getElementById("inpCode").value; item.label = document.getElementById("inpLabel").value; item.url = document.getElementById("inpUrl").value; } 
      else { item.text = document.getElementById("inpText").value; item.url = document.getElementById("inpUrl").value; item.img = document.getElementById("inpImg").value; }
      env._forceUpdate = true; render();
    }
    modal.classList.add("hidden");
  };

  // --- Search & Fly ---
  searchInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
      const term = searchInput.value.toLowerCase();
      const target = STATE.envelopes.find(env => env.name.toLowerCase().includes(term));
      if (target) {
        // Fly to target
        const el = document.getElementById(target.id);
        STATE.cam.x = -target.x + window.innerWidth/2 - 140;
        STATE.cam.y = -target.y + window.innerHeight/2 - 100;
        STATE.cam.z = 1; // Reset zoom para ver bem
        applyCam();
        
        // Highlight visual
        el.classList.add('highlight');
        setTimeout(() => el.classList.remove('highlight'), 1500);
      } else {
        alert("Envelope n√£o encontrado.");
      }
    }
  });

  // --- Drag & Cam ---
  function startDragEnv(e, env) { e.preventDefault(); const el = document.getElementById(env.id); el.style.zIndex = 200; const sx=e.clientX, sy=e.clientY, ex=env.x, ey=env.y, z=STATE.cam.z; const move = ev => { env.x = ex + (ev.clientX-sx)/z; env.y = ey + (ev.clientY-sy)/z; el.style.left=env.x+"px"; el.style.top=env.y+"px"; }; const up = () => { window.removeEventListener("pointermove", move); window.removeEventListener("pointerup", up); el.style.zIndex=env.isOpen?100:""; }; window.addEventListener("pointermove", move); window.addEventListener("pointerup", up); }
  function applyCam() { 
    world.style.transform = `translate(${STATE.cam.x}px, ${STATE.cam.y}px) scale(${STATE.cam.z})`; 
    // Grid Infinito: Movemos o background-position para simular infinito
    viewport.style.backgroundPosition = `${STATE.cam.x}px ${STATE.cam.y}px`;
    viewport.style.backgroundSize = `${40 * STATE.cam.z}px ${40 * STATE.cam.z}px`;
  }
  let panning=false, panS={};
  viewport.onpointerdown = e => { if(e.target.closest('.envelope')) return; panning=true; viewport.classList.add('dragging'); panS={x:e.clientX, y:e.clientY, cx:STATE.cam.x, cy:STATE.cam.y}; viewport.setPointerCapture(e.pointerId); };
  viewport.onpointermove = e => { if(!panning) return; STATE.cam.x=panS.cx+(e.clientX-panS.x); STATE.cam.y=panS.cy+(e.clientY-panS.y); applyCam(); };
  viewport.onpointerup = () => { panning=false; viewport.classList.remove('dragging'); };
  viewport.onwheel = e => { if(!e.ctrlKey)return; e.preventDefault(); const f=e.deltaY>0?0.9:1.1; STATE.cam.z=Math.max(0.2, Math.min(3, STATE.cam.z*f)); applyCam(); };

  // --- Toolbar ---
  document.getElementById("btnAddEnv").onclick = () => { STATE.envelopes.push({id:`env-${Date.now()}`, name:"Novo", color:ENV_PALETTE[0], x: -STATE.cam.x+window.innerWidth/2-140, y: -STATE.cam.y+window.innerHeight/2-100, isOpen:true, team:[], tags:[]}); render(); };
  document.getElementById("btnExport").onclick = () => { const b=new Blob([`window.RDT_DATA = ${JSON.stringify(STATE, null, 2)};`], {type:"text/javascript"}); const a=document.createElement("a"); a.href=URL.createObjectURL(b); a.download="data.js"; a.click(); };
  document.getElementById("btnLoad").onclick = () => document.getElementById("fileInput").click();
  document.getElementById("fileInput").onchange = e => { const f=e.target.files[0]; if(f){ const r=new FileReader(); r.onload=ev=>{ try{ STATE=JSON.parse(ev.target.result.replace(/^window\.RDT_DATA\s*=\s*/,'').replace(/;?\s*$/,'')); applyCam(); render(); }catch(e){alert("Erro");} }; r.readAsText(f); e.target.value=''; }};
  document.getElementById("btnImportLegacy").onclick = () => document.getElementById("fileInputLegacy").click();
  document.getElementById("fileInputLegacy").onchange = e => {
    const f=e.target.files[0]; if(!f) return;
    const r = new FileReader();
    r.onload = ev => {
      try {
        let jsonStr = ev.target.result.replace(/window\.GROUPS\s*=\s*/, '').trim().replace(/;$/, '');
        const groups = new Function(`return ${jsonStr}`)();
        if(Array.isArray(groups)) {
          let x = 100;
          groups.forEach(g => {
            const newEnv = { id: g.id || `env-${Date.now()}-${Math.random()}`, name: g.name, color: ENV_PALETTE[1], x: x, y: 100, isOpen: false, icon: g.icon || "", description: "", team: g.items || [], tags: [] };
            if(g.iconHref) { newEnv.tags.push({ id: Date.now()+Math.random(), text: "Material de Refer√™ncia", url: g.iconHref, img: g.icon || "https://placehold.co/60x60/FFF/000?text=REF" }); }
            STATE.envelopes.push(newEnv); x += 300;
          });
          render(); alert(`Migrado: ${groups.length} envelopes.`);
        }
      } catch(err) { alert("Erro ao importar legacy."); }
    };
    r.readAsText(f); e.target.value='';
  };

  init();
})();
</script>
</body>
</html>